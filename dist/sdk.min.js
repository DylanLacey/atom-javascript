"use strict";function IronSourceAtom(t){t=t||{};var e="https://track.atom-data.io/",s="V1";this.options={endpoint:!!t.endpoint&&t.endpoint.toString()||e,apiVersion:t.apiVersion&&t.apiVersion.match(/^V\d+(.\d)?$/g)?t.apiVersion:s,auth:t.auth?t.auth:""}}function sizeof(t){for(var e=[t],s=0,r=0;r<e.length;r++)switch(typeof e[r]){case"boolean":s+=4;break;case"number":s+=8;break;case"string":s+=2*e[r].length;break;case"object":if("[object Array]"!=Object.prototype.toString.call(e[r]))for(var a in e[r])s+=2*a.length;for(var a in e[r]){for(var o=!1,n=0;n<e.length;n++)if(e[n]===e[r][a]){o=!0;break}o||e.push(e[r][a])}}return s}function Request(t,e){this.endpoint=t.toString()||"",this.params=e||{},this.headers={contentType:"application/json;charset=UTF-8"},this.timer=1e3,this.xhr=XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")}function Response(t,e,s){this.error=t,this.response=e,this.status=s}function Tracker(t){this.flushInterval=t.flushInterval?t.flushInterval:10,this.bulkLen=t.bulkLen?t.bulkLen:1e3,this.bulkSize=t.bulkSize?t.bulkSize:64,this.httpMethod=t.httpMethod?t.httpMethod:"POST",this.accumulated=[],this.atom=new IronSourceAtom(t)}IronSourceAtom.prototype.putEvent=function(t,e){if(t=t||{},!t.data||!t.table)throw new Error("Data and table is required");t.apiVersion=this.options.apiVersion,t.auth=this.options.auth;var s=new Request(this.options.endpoint,t);return t.method&&"GET"===t.method.toUpperCase()?s.get(e):s.post(e)},IronSourceAtom.prototype.putEvents=function(t,e){if(t=t||{},!(t.data&&t.data instanceof Array&&t.table))throw new Error("Data (must be array) and table is required");t.apiVersion=this.options.apiVersion,t.auth=this.options.auth;var s=new Request(this.options.endpoint+"/bulk",t);return t.method&&"GET"===t.method.toUpperCase()?s.get(e):s.post(e)},IronSourceAtom.prototype.health=function(t){var e=new Request(this.options.endpoint,null);return e.get(t)},"undefined"!=typeof module&&module.exports&&(module.exports={IronSourceAtom:IronSourceAtom,Request:Request}),Request.prototype.post=function(t){if(!this.params.table||!this.params.data)throw new Error("Table and data required fields for send event");var e=this.xhr,s=JSON.stringify({data:this.params.data,table:this.params.table,apiVersion:this.params.apiVersion,auth:this.params.auth}),r=this;e.open("POST",this.endpoint,!0),e.setRequestHeader("Content-type",this.headers.contentType),e.onreadystatechange=function(){if(e.readyState===XMLHttpRequest.DONE){var s;if(200==e.status)s=new Response(!1,e.response,e.status),!!t&&t(s.data());else if(e.status>=500){if(r.timer>=12e4)throw new Error("Server not response more then 2min");setTimeout(function(){console.log(r.timer),r.timer=2*r.timer,r.post(t)},r.timer)}else s=new Response(!0,e.response,e.status),!!t&&t(s.err())}},e.send(s)},Request.prototype.get=function(t){if(!this.params.table||!this.params.data)throw new Error("Table and data required fields for send event");var e,s=this.xhr,r=JSON.stringify({table:this.params.table,data:this.params.data,apiVersion:this.params.apiVersion,auth:this.params.auth}),a=this;try{e=btoa(r)}catch(o){console.log("error="+o)}s.open("GET",this.endpoint+"?data="+e,!0),s.setRequestHeader("Content-type",this.headers.contentType),s.onreadystatechange=function(){if(s.readyState===XMLHttpRequest.DONE){var e;if(200==s.status)e=new Response(!1,s.response,s.status),!!t&&t(e.data());else if(s.status>=500){if(a.timer>=12e4)throw new Error("Server not response more then 2min");setTimeout(function(){a.timer=2*a.timer,a.get(t)},a.timer)}else e=new Response(!0,s.response,s.status),!!t&&t(e.err())}},s.send()},Response.prototype.data=function(){return this.error?null:{err:null,data:JSON.parse(this.response),status:this.status}},Response.prototype.err=function(){return this.error?{err:this.response,data:null,status:this.status}:null},Tracker.prototype.track=function(t,e){var s=this;this.timer||(this.timer=setTimeout(function(){s.flush()},1e3*s.flushInterval)),t&&e.length&&(this.stream=t,this.accumulated.push(e),this.accumulated.length!=this.bulkLen&&sizeof(this.accumulated)!=1024*this.bulkSize||this.flush())},Tracker.prototype.flush=function(){var t,e=this;clearTimeout(this.timer),e.accumulated.length&&(t={table:e.stream,data:e.accumulated,method:e.httpMethod},1==e.accumulated.length?e.atom.putEvent(t,callback):e.atom.putEvents(t,callback)),this.accumulated=[],this.timer=null,e.track()};