!function(t){"use strict";function e(t){t=t||{};var e="https://track.atom-data.io/",s="V1";this.options={endpoint:!!t.endpoint&&t.endpoint.toString()||e,apiVersion:s,auth:t.auth?t.auth:""}}function s(t){for(var e=[t],s=0,a=0;a<e.length;a++)switch(typeof e[a]){case"boolean":s+=4;break;case"number":s+=8;break;case"string":s+=2*e[a].length;break;case"object":if("[object Array]"!=Object.prototype.toString.call(e[a]))for(var r in e[a])s+=2*r.length;for(var r in e[a]){for(var n=!1,i=0;i<e.length;i++)if(e[i]===e[a][r]){n=!0;break}n||e.push(e[a][r])}}return s}function a(t,e){this.endpoint=t.toString()||"",this.params=e||{},this.headers={contentType:"application/json;charset=UTF-8"},this.timer=1e3,this.xhr=XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")}function r(t,e,s){this.error=t,this.response=e,this.status=s}function n(t){this.flushInterval=t.flushInterval?t.flushInterval:10,this.bulkLen=t.bulkLen?t.bulkLen:1e4,this.bulkSize=t.bulkSize?t.bulkSize:64,this.httpMethod=t.httpMethod?t.httpMethod:"POST",this.accumulated=[],this.atom=new e(t)}e.prototype.putEvent=function(t,e){if(t=t||{},!t.table)throw new Error("Stream is required");if(!t.data)throw new Error("Data is required");t.apiVersion=this.options.apiVersion,t.auth=this.options.auth;var s=new a(this.options.endpoint,t);return t.method&&"GET"===t.method.toUpperCase()?s.get(e):s.post(e)},e.prototype.putEvents=function(t,e){if(t=t||{},!(t.data&&t.data instanceof Array&&t.data.length))throw new Error("Data (must be not empty array) is required");if(!t.table)throw new Error("Table is required");t.apiVersion=this.options.apiVersion,t.auth=this.options.auth;var s=new a(this.options.endpoint+"/bulk",t);return t.method&&"GET"===t.method.toUpperCase()?s.get(e):s.post(e)},e.prototype.health=function(t){var e=new a(this.options.endpoint,{table:"health_check",data:"null"});return e.get(t)},"undefined"!=typeof module&&module.exports&&(module.exports={IronSourceAtom:e,Request:a,Response:r}),a.prototype.post=function(t){if(!this.params.table||!this.params.data)throw new Error("Table and data required fields for send event");var e=this.xhr,s=JSON.stringify({data:this.params.data,table:this.params.table,apiVersion:this.params.apiVersion,auth:this.params.auth}),a=this;e.open("POST",this.endpoint,!0),e.setRequestHeader("Content-type",this.headers.contentType),e.setRequestHeader("x-ironsource-atom-sdk-type","js"),e.setRequestHeader("x-ironsource-atom-sdk-version","1.0"),e.onreadystatechange=function(){if(e.readyState===XMLHttpRequest.DONE){var s;e.status>=200&&e.status<300?(s=new r(!1,e.response,e.status),!!t&&t(s.data())):e.status>=500?a.timer>=12e4?(s=new r(!0,e.response,e.status),!!t&&t(s.err())):setTimeout(function(){a.timer=2*a.timer,a.post(t)},a.timer):(s=new r(!0,e.response,e.status),!!t&&t(s.err()))}},e.send(s)},a.prototype.get=function(t){if(!this.params.table||!this.params.data)throw new Error("Table and data required fields for send event");var e,s=this.xhr,a=JSON.stringify({table:this.params.table,data:this.params.data,apiVersion:this.params.apiVersion,auth:this.params.auth}),n=this;try{e=btoa(a)}catch(i){console.log("error="+i)}s.open("GET",this.endpoint+"?data="+e,!0),s.setRequestHeader("Content-type",this.headers.contentType),s.setRequestHeader("x-ironsource-atom-sdk-type","js"),s.setRequestHeader("x-ironsource-atom-sdk-version","1.0"),s.onreadystatechange=function(){if(s.readyState===XMLHttpRequest.DONE){var e;s.status>=200&&s.status<300?(e=new r(!1,s.response,s.status),!!t&&t(e.data())):s.status>=500?n.timer>=12e4?(e=new r(!0,s.response,s.status),!!t&&t(e.err())):setTimeout(function(){n.timer=2*n.timer,n.get(t)},n.timer):(e=new r(!0,s.response,s.status),!!t&&t(e.err()))}},s.send()},r.prototype.data=function(){return this.error?null:{err:null,data:JSON.parse(this.response),status:this.status}},r.prototype.err=function(){try{return this.error?{err:JSON.parse(this.response),data:null,status:this.status}:null}catch(t){return this.error?{err:this.response,data:null,status:this.status}:null}},n.prototype.track=function(t,e){var a=this;this.timer||(this.timer=setTimeout(function(){a.flush()},1e3*a.flushInterval)),t&&e.length&&(this.stream=t,this.accumulated.push(e),this.accumulated.length!=this.bulkLen&&s(this.accumulated)!=1024*this.bulkSize||this.flush())},n.prototype.flush=function(){var t,e=this;clearTimeout(this.timer),e.accumulated.length&&(t={table:e.stream,data:e.accumulated,method:e.httpMethod},1==e.accumulated.length?e.atom.putEvent(t,callback):e.atom.putEvents(t,callback)),this.accumulated=[],this.timer=null,e.track()}}();